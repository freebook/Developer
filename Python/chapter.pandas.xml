<?xml version="1.0" encoding="UTF-8"?>
<chapter id="pandas">
	<title>Pandas</title>
	<subtitle>Powerful data structures for data analysis, time series, and statistics</subtitle>
	<section>
		<title>安装 pandas</title>
		<screen>
		<![CDATA[
pip install pandas		
		]]>
		</screen>

	</section>
	<section>
		<title>HTML 表格处理</title>
		<para>read_html() 可以萃取 HTML table 标签中的数据。</para>
		<screen>
		<![CDATA[
pip install lxml		
		]]>
		</screen>
		<para>获取页面中所有table的数据</para>
		<programlisting>
		<![CDATA[
import pandas as pd

url = "http://www.stats.gov.cn/tjsj/zxfb/202103/t20210330_1815829.html"
data = pd.read_html(url)

print(data)
		]]>
		</programlisting>
		<para>多个 table 会返回一个数组，通过数组下标可以读取指定表格。</para>
		<programlisting>
		<![CDATA[
import pandas as pd

url = "http://www.stats.gov.cn/tjsj/zxfb/202103/t20210330_1815829.html"
data = pd.read_html(url)[1]

print(data)		
		]]>
		</programlisting>
		<para>获取 html table 标签 id 属性为 oTable 的表格数据 </para>
		<programlisting>
		<![CDATA[
import pandas as pd

url = "http://fund.eastmoney.com/fund.html"
data = pd.read_html(url,attrs = {'id': 'oTable'})

print(data)		
		]]>
		</programlisting>
	</section>
	<section>
		<title>Excel 处理</title>
		<screen>
		<![CDATA[
neo@MacBook-Pro-Neo ~ % pip install xlrd		
		]]>
		</screen>
		<programlisting>
		<![CDATA[
#!/usr/bin/python3
# -*- coding: UTF-8 -*-
import pandas as pd
# 默认读取第一个工作表
df = pd.read_excel("团购2021.xlsx")
data = df.head()  # 默认读取前5行的数据
print("当前默认工作表：\n{0}".format(data))  # 格式化输出	
		]]>
		</programlisting>

		<section>
			<title>工作表</title>
			<para>获取Excel文件中的工作表</para>
			<programlisting>
			<![CDATA[
xls = pd.ExcelFile("团购2021.xlsx")
sheet_names = xls.sheet_names
print(sheet_names)
			]]>
			</programlisting>
			<screen>
			<![CDATA[
df = pd.read_excel("团购2021.xlsx", None)
print(df.keys())
for k,v in df.items():
    print(k)
			]]>
			</screen>
		</section>
	</section>
	<section>
		<title>将数据保存到CSV文件</title>
		<programlisting>
		<![CDATA[
import pandas as pd

months=[202001,202002,202003,202004,202005,202006,202007,202008,202009,202010,202011,202012]

for month in months:
    print(month)
    weather = pd.read_html(f'http://www.tianqihoubao.com/lishi/wanzhou/month/{month}.html', encoding='gb18030', header=0)[0]
    print(weather)
    weather.to_csv(f'/tmp/{month}天气预报数据.csv', mode='a+', index=False, header=False)		
		]]>
		</programlisting>
	</section>
	
	<section>
		<title>FAQ</title>
		<section>
			<title>xlrd.biffh.XLRDError: Excel xlsx file; not supported</title>
			<screen>
			<![CDATA[
neo@MacBook-Pro-Neo ~ % pip show xlrd
Name: xlrd
Version: 2.0.1
Summary: Library for developers to extract data from Microsoft Excel (tm) .xls spreadsheet files
Home-page: http://www.python-excel.org/
Author: Chris Withers
Author-email: chris@withers.org
License: BSD
Location: /Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages
Requires: 
Required-by: 			
			]]>
			</screen>
			<para>降级 xlrd 到 1.2.0 可以解决</para>
			<screen>
			<![CDATA[
pip uninstall xlrd
pip install xlrd==1.2.0			
			]]>
			</screen>
		</section>
	</section>

</chapter>