<chapter id="sqlalchemy">
	<title>Sqlalchemy</title>
	<section>
		<title>安装 Sqlalchemy</title>
		<screen>
		<![CDATA[
pip install pymysql
pip install sqlalchemy		
		]]>
		</screen>
	</section>
	<section>
		<title>链接测试</title>
		<programlisting>
		<![CDATA[
from sqlalchemy import create_engine

HOST_NAME = '127.0.0.1'	# 主机
PORT = '3306'	# 端口号
DB_NAME = '数据库名称，需提前创建好'
USERNAME = '用户名'
PASSWORD = '密码'

DB_URL = 'mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8'.format(
    USERNAME, PASSWORD, HOST_NAME, PORT, DB_NAME
)
engine = create_engine(DB_URL)

if __name__ == '__main__':
    connection = engine.connect()
    result = connection.execute('select 1')
    print(result.fetchone())
		]]>
		</programlisting>
		<para>打印 SQL 语句</para>
		<programlisting>
		<![CDATA[
SQLAlchemy 通过 echo=true，将连接这个数据库引擎的所有执行语句打印出来：

engine = create_engine("<db_rul>", echo=True)		
		]]>
		</programlisting>
	</section>
	<section>
		<title>创建表</title>
		<programlisting>
		<![CDATA[
models.Base.metadata.create_all(bind=engine)		
		]]>
		</programlisting>
	</section>
	<section>
		<title>Session</title>
		<programlisting>
		<![CDATA[
# 创建数据库会话
Session = sessionmaker(autocommit=False, autoflush=False, bind=engine)		
		]]>
		</programlisting>
	</section>
	<section id="sqlalchemy.models">
		<title>模型定义</title>
		<programlisting>
		<![CDATA[
name = Column(String(20), default=None, nullable=False, comment="姓名")		
		]]>
		</programlisting>
		<section>
			<title>外键</title>
			<programlisting>
			<![CDATA[
class Picture(Base):
    __tablename__ = "picture"
    id = Column(BIGINT, autoincrement=True, primary_key=True, comment="唯一ID")
    android_id = Column(String(16), nullable=False, comment="安卓设备ID")
    session = Column(String(36), nullable=False, unique=True, comment="回话ID")
    prompt = Column(String(250), nullable=False, comment="提示词")
    thumbnail = Column(String(250), nullable=True, comment="缩图")
    original = Column(String(250), nullable=True, comment="原始图片")
    image = Column(String(250), nullable=True, comment="图片")
    story = Column(TEXT, nullable=True, comment="故事")
    share = Column(Boolean, nullable=False, default=True, comment="共享")
    like = Column(INTEGER, nullable=False, default=0, comment="点赞")
    ctime = Column(DateTime, default=datetime.now(), comment="创建时间")
    mtime = Column(DateTime, default=datetime.now(), comment="修改时间")


class PictureLike(Base):
    __tablename__ = "picture_like"
    id = Column(BIGINT, autoincrement=True, primary_key=True, comment="唯一ID")
    android_id = Column(String(16), nullable=False, comment="安卓设备ID")
    picture_id = Column(
        BIGINT, ForeignKey("picture.id"), nullable=False, comment="图片ID"
    )
    ctime = Column(DateTime, default=datetime.now(), comment="创建时间")			
			]]>
			</programlisting>
		</section>
	</section>
	<section>
		<title>增删改</title>
		<para>插入数据</para>
		<programlisting>
		<![CDATA[
from sqlalchemy.orm import sessionmaker
​
# 创建会话session
Session = sessionmaker(bind=engine)
session = Session()
# 新增数据
new_data = Employees(name='Neo', sex='男', age=25, birth='1980-10-24', jobs='CEO')
session.add(new_data)
session.commit()
session.close()		
		]]>
		</programlisting>
		<para>删除数据</para>
		<programlisting>
		<![CDATA[
from sqlalchemy.orm import sessionmaker
​
# 创建会话session
Session = sessionmaker(bind=engine)
session = Session()
# 删除数据
data = session.query(Employees).filter_by(id=1).delete()
print('已删除数据的数据量为:', data)
session.commit()
session.close()

session.query(Students).filter(Students.name == 'netkiller').delete()
session.commit()
		]]>
		</programlisting>
		<para>修改数据</para>
		<programlisting>
		<![CDATA[
# 创建会话session
Session = sessionmaker(bind=engine)
session = Session()

# 更新数据
session.query(Employees).filter_by(id=1).update({Employees.age: 12})
session.commit()
session.close()	

# 查询后更新数据
data = session.query(Employees).filter_by(id=5).first()
data.name = '张三'
session.commit()
session.close()	
		]]>
		</programlisting>
	</section>
	<section>
		<title>查询</title>
		<para>打印SQL</para>
		<programlisting>
		<![CDATA[
        query = session.query(PictureLike).filter(
            PictureLike.android_id == android_id,
            PictureLike.picture_id == picture_id,
        )
        print(f"SQL: {query}")		
		]]>
		</programlisting>
		<para>所有数据</para>
		<programlisting>
		<![CDATA[
results = session.query(Player).all()
for result in results:
    print(f"查询结果为: {result}")		
		]]>
		</programlisting>
		<para>第一条数据</para>
		<programlisting>
		<![CDATA[
first = session.query(Player).first()
print(first)		
		]]>
		</programlisting>
		<para>LIKE</para>
		<programlisting>
		<![CDATA[
query_result = session.query(Player).filter(Player.name.like("%sa%"))		
		]]>
		</programlisting>
		<para>与操作符 and</para>
		<programlisting>
		<![CDATA[
query_result = session.query.filter(and_(Player.name == 'Salah', Player.id > 1))		
# 单个filter()中设置多个表达式
query_result = session.query.filter(Player.name == 'Salah', Player.id > 1)

# 使用多个filter()
query_result = session.query.filter(Player.name == 'Salah').filter(Player.id > 1)
		]]>
		</programlisting>
		<para>或操作符 or</para>
		<programlisting>
		<![CDATA[
from sqlalchemy import or_
		
results = session.query.filter(or_(Player.name == 'Salah', Player.id > 1))		
		]]>
		</programlisting>
		<para>IN 包含</para>
		<programlisting>
		<![CDATA[
query_result = session.query.filter(Player.club.in_(["Liverpool", "Chelsea"]))		
		]]>
		</programlisting>
		<para>NOT IN 排除</para>
		<programlisting>
		<![CDATA[
query_result = session.query.filter(~Player.country.in_(["Eygpt", "China"]))		
		]]>
		</programlisting>
		<para>slice 切片操作，返回 list</para>
		<programlisting>
		<![CDATA[
slice(起始值，结束值)

results = session.query(Arctire).slice(90,100).all()
print(results)

我们也可以使用如下方法，获得同样的结果。
results = session.query(Arctire)[90:100]
		]]>
		</programlisting>
	</section>
	<section id="models.label">
		<title>标签</title>
		<programlisting>
		<![CDATA[
        results = (
            session.query(Picture.image.label("image"))
            .filter(Picture.android_id == android_id)
            .all()
        )
        data = [url[0] for url in results]		
		]]>
		</programlisting>
	</section>
	<section id="query.count">
		<title>统计数量</title>
		<programlisting>
		<![CDATA[
result = session.query(Students).count()
result = session.query(Students).filter(Students.name == 'neo').count()		
		]]>
		</programlisting>
	</section>
	<section id="query.order_by">
		<title>排序</title>
		<programlisting>
		<![CDATA[
results = session.query(Students).order_by(Students.id.desc()).all()	
		]]>
		</programlisting>
	</section>
	<section id="query.exists">
		<title>查询数据是否存在</title>
		<section>
			<title>返回 exists SQL 语句</title>
			<programlisting>
		<![CDATA[
        exist = (
            session.query(PictureLike)
            .filter(
                PictureLike.android_id == android_id,
                PictureLike.picture_id == picture_id,
            )
            .exists()
        )		
		]]>
		</programlisting>
		<para>输出结果</para>
		<screen>
		<![CDATA[
EXISTS (SELECT 1 
FROM picture_like 
WHERE picture_like.android_id = :android_id_1 AND picture_like.picture_id = :picture_id_1)		
		]]>
		</screen>
		</section>
		<section>
			<title>exists()</title>
			<programlisting>
		<![CDATA[
from sqlalchemy import exists

it_exists = Session.query(
    exists().where( SomeObject.field==value )
).scalar()		
		]]>
			</programlisting>
		</section>
		<section>
			<title>query.exists()</title>
			<programlisting>
			<![CDATA[
        query = session.query(PictureLike).filter(
            PictureLike.android_id == android_id,
            PictureLike.picture_id == picture_id,
        )
        print(f"SQL: {query}")
        exists = session.query(query.exists()).scalar()
        print(exists)
			]]>
			</programlisting>
		</section>
	</section>
	<section id="sqlalchemy.func">
		<title></title>
		<programlisting>
		<![CDATA[
from sqlalchemy import func		
		]]>
		</programlisting>
		<section>
			<title>count</title>
			<programlisting>
			<![CDATA[
        count, min, max = (
            session.query(
                func.count().label("count"),
                func.min(Picture.id).label("min"),
                func.max(Picture.id).label("max"),
            )
            .filter(Picture.android_id == android_id)
            .one()
        )
        data = {"count": count, "min": min, "max": max}			
			]]>
			</programlisting>
		</section>
		<section>
			<title>min/max</title>
			<programlisting>
			<![CDATA[
        data = session.query(
            func.min(Picture.id).label("min"), func.max(Picture.id).label("max")
        ).one()	
        
        min, max = session.query(
            func.min(Picture.id).label("min"), func.max(Picture.id).label("max")
        ).one()
        
        data = {"min": min, "max": max}        
			]]>
			</programlisting>
		</section>
	</section>
</chapter>	